<?php
/**
 * Name: Marketplace App
 * Description: Simple marketplace application with bitcoin wallet support
 * Version: 1.0
 * Author: Super Testnet <https://highlevelbitcoin.com/>
 */
use Friendica\Core\Hook;
use Friendica\Database\DBA;
use Friendica\DI;
use Friendica\Model\Profile;
use Friendica\Model\User;

function marketplace_install() {
	Hook::register( 'network_tabs', 'addon/marketplace/marketplace.php', 'tab_addition' );
	Hook::register( 'page_header', 'addon/marketplace/marketplace.php', 'marketplace_alterheader' );
	makeMarketplaceTables();
}

function tab_addition( $a, &$b ) {
        $b[ 'tabs' ][] = [
		'label'	=> DI::l10n()->t( 'Marketplace' ),
		'url'	=> 'marketplace/',
		'sel'	=> $selectedTab == 'marketplace' ? 'active' : '',
		'title'	=> DI::l10n()->t( 'View marketplace' ),
		'id'	=> 'marketplace-tab',
		'accesskey' => 'v',
	];
}

function marketplace_alterheader( $a, &$navHtml ) {
	$username = getUsernameById( getCurrentUserId() );
	$addScriptTag = '
		<script>
			$(document).ready(function(){
			        var tab0 = document.createElement( "li" );
			        tab0.role = "presentation";
			        tab0.id = "marketplace";
			        var link0 = document.createElement( "a" );
			        link0.role = "menuitem";
			        link0.href = "/marketplace/";
			        link0.title = "View marketplace";
			        link0.innerText = "Marketplace";
			        tab0.append( link0 );
			        if ( document.getElementsByTagName( "title" )[ 0 ].innerText.includes( " | Community" ) ) {
					document.getElementsByClassName( "tabs" )[ 0 ].append( tab0 );
//                                        var i; for ( i=0; i<document.getElementsByClassName( "tabs" ).length; i++ ) {
  //                                              if ( !document.getElementsByClassName( "tabs" )[ i ].getElementsByClassName( "dropdown-menu" )[ 0 ] || window.innerWidth > 600 ) {
    //                                                    document.getElementsByClassName( "tabs" )[ i ].append( tab0 );
    //                                            } else {
      //                                                  document.getElementsByClassName( "tabs" )[ i ].getElementsByClassName( "dropdown-menu" )[ 0 ].append( tab0 );
        //                                        }
          //                              }
			        }
			        link0.href = "/marketplace/my-store/";
			        tab0.innerHTML = "";
			        tab0.append( link0 );
			        if ( window.location.href.includes( "' . $username . '" ) ) {
					var i; for ( i=0; i<document.getElementsByClassName( "tabs" ).length; i++ ) {
						if ( !document.getElementsByClassName( "tabs" )[ i ].getElementsByClassName( "dropdown-menu" )[ 0 ] || window.innerWidth > 600  ) {
				                	document.getElementsByClassName( "tabs" )[ i ].append( tab0 );
						} else {
							document.getElementsByClassName( "tabs" )[ i ].getElementsByClassName( "dropdown-menu" )[ 0 ].append( tab0 );
						}
					}
			        }
			});
		</script>
	' . "\r\n";
	DI::page()[ 'htmlhead' ] .= $addScriptTag;
}

function marketplace_module() {}

function marketplace_init($a) {

$x = <<< EOT
	<!-- Any html or javascript added here will go in the header of your homepage -->

	<script type="text/javascript">var link = document.createElement("link");link.rel="stylesheet";link.href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css";link.integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==";link.setAttribute("crossorigin", "");document.getElementsByTagName("head")[0].appendChild(link);</script>

	<script type="text/javascript">var style = document.createElement("style");var css = document.createTextNode("#mapid {height: 486px;}");style.appendChild(css);document.getElementsByTagName("head")[0].appendChild(style);</script>

	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

	<script>
		$(document).ready(function(){
	                var wrapper = document.createElement( "div" );
	                wrapper.className = "tabbar-wrapper";
	                var tabbar = document.createElement( "ul" );
	                tabbar.className = "tabbar list-inline visible-lg visible-md visible-sm visible-xs";
	                var menuitem = document.createElement( "li" );
			menuitem.style.width = "100%";
	                var tabs = document.createElement( "ul" );
	                tabs.className = "tabs flex-nav";
	                tabs.role = "menu";
			var tab0 = document.createElement( "li" );
			tab0.role = "presentation";
			tab0.id = "all-products";
                        var tab1 = document.createElement( "li" );
                        tab1.role = "presentation";
                        tab1.id = "map";
			var tab2 = document.createElement( "li" );
	                tab2.role = "presentation";
	                tab2.id = "my-store";
	                var tab3 = document.createElement( "li" );
	                tab3.role = "presentation";
	                tab3.id = "new-product";
	                var tab4 = document.createElement( "li" );
	                tab4.role = "presentation";
	                tab4.id = "wallet";
			var link0 = document.createElement( "a" );
			link0.role = "menuitem";
			link0.href = "/marketplace/";
			link0.title = "View all products";
			link0.innerText = "All products";
                        var link1 = document.createElement( "a" );
                        link1.role = "menuitem";
                        link1.href = "/marketplace/map/";
                        link1.title = "View product map";
                        link1.innerText = "Map";
	                var link2 = document.createElement( "a" );
	                link2.role = "menuitem";
	                link2.href = "/marketplace/my-store/";
	                link2.title = "View and manage your products";
	                link2.innerText = "My store";
	                var link3 = document.createElement( "a" );
	                link3.role = "menuitem";
	                link3.href = "/marketplace/new-product/";
	                link3.title = "Create a new product";
	                link3.innerText = "New product";
	                var link4 = document.createElement( "a" );
	                link4.role = "menuitem";
	                link4.href = "/marketplace/wallet/";
	                link4.title = "View your bitcoin wallet";
	                link4.innerText = "Wallet";
			tab0.append( link0 );
                        tab1.append( link1 );
	                tab2.append( link2 );
//	                tab3.append( link3 );
	                tab4.append( link4 );
			tabs.append( tab0, tab1, tab2, tab3, tab4 );
	                menuitem.append( tabs );
	                tabbar.append( menuitem );
	                wrapper.append( tabbar );
	                document.getElementById( "tabmenu" ).append( wrapper );
                        document.getElementById( "tabmenu" ).style.width = "100%";
		});
	</script>
EOT;
	DI::page()['htmlhead'] .= $x;

}

function marketplace_content($app) {
	$base = DI::baseUrl()->get();

	$o = '';

	if ( strpos( $_SERVER['REQUEST_URI'], '/details/' ) > -1 ) {
		$product = $_GET[ "product" ];
                $r = q( "SELECT * FROM products WHERE id = $product" );
                if ( DBA::isResult( $r ) ) {
                        $data = json_encode( $r[ 0 ] );
                }
		$creator = getUsernameById( $r[ 0 ][ "uid" ] );
		$name = $r[ 0 ][ "name" ];
		$description = $r[ 0 ][ "descr" ];
		$latlong = $r[ 0 ][ "latlong" ];
		$price = "$" . $r[ 0 ][ "price" ] / 100 . " (USD)";
	        $o .=  <<< EOT
	        <h3>$name</h3>
		<p id="description">$description</p>
		<p>Created by <a href="$base/profile/$creator">$creator</a></p>
		<p>Located at $latlong</p>
		<p>Price: $price</p>
EOT;
	}

	if ( strpos( $_SERVER['REQUEST_URI'], '/my-store/' ) > -1 ) {
                $uid = getCurrentUserId();
                $r = q( "SELECT * FROM store WHERE uid = $uid" );
                if ( DBA::isResult( $r ) ) {
                        $data = json_encode( $r );
                }
/*
		if ( empty( $data ) && getCurrentUserId() != 0 && $_POST[ "store-name" ] && $_POST[ "description" ] && $_POST[ "latitude" ] && $_POST[ "longitude" ] ) {
                        $storename = $_POST[ "store-name" ];
                        $description = $_POST[ "description" ];
			$latlong = $_POST[ "latitude" ] . "," . $_POST[ "longitude" ];
			$fields[ 'uid' ] = $uid;
                	$fields[ 'name' ] = filter_var( $storename, FILTER_SANITIZE_STRING );
                	$fields[ 'descr' ] = filter_var( $description, FILTER_SANITIZE_STRING );
                	$fields[ 'latlong' ] = filter_var( $latlong, FILTER_SANITIZE_STRING );
                	DBA::insert( 'store', $fields );
                }
		$r = q( "SELECT * FROM store WHERE uid = $uid" );
                if ( DBA::isResult( $r ) ) {
                        $data = json_encode( $r[ 0 ] );
                }
		if ( empty( $data ) && getCurrentUserId() != 0 ) {
		        $o .=  <<< EOT
		        <h3>Create your store</h3>
			<div id="instructions" style="padding: 10px; border: 3px solid black;">
				<p style="font-weight: bold;">Instructions</p>
				<p>Enter a name and description for your store. You'll also need a latitude and a longitude which help us place a pin on our map. Get your latitude and longitude from <a href="https://latlong.net/" target="_blank">latlong.net</a>. On that site, enter a place name or click on the map. The latitude and longitude appear as two numbers separated by a comma. The left number is latitude, the right number is longitude. If either number has a negative sign, don't delete it -- the negative sign is important for that number so that your pin gets placed in the right spot on the map.</p>
			</div>
		        <form method="post">
	                	<p style="font-weight: bold;">Store name</p>
	                	<input type="text" id="store-name" name="store-name"><br><br>
	                	<p style="font-weight: bold;">Description</p>
	                	<textarea cols="40" rows="6" id="description" name="description"></textarea><br><br>
				<p style="font-weight: bold;">Latitude</p>
				<input type="text" id="latitude" name="latitude"><br><br>
	                	<p style="font-weight: bold;">Longitude</p>
	                	<input type="text" id="longitude" name="longitude"><br><br>
	        	        <input type="submit" id="submit" name="submit">
			</form>
			<br><br>
EOT;
		} else if ( getCurrentUserId() != 0 ) {
	                $creator = getUsernameById( $r[ 0 ][ "uid" ] );
	                $name = $r[ 0 ][ "name" ];
	                $description = $r[ 0 ][ "descr" ];
	                $latlong = $r[ 0 ][ "latlong" ];
	                $o .=  <<< EOT
	                <h3>$name</h3>
	                <p id="description">$description</p>
	                <p>Created by <a href="$base/profile/$creator">$creator</a></p>
	                <p>Located at $latlong</p>
	                <h3>Products</h3>
*/
		if ( getCurrentUserId() != 0 ) {
	                $r = q( "SELECT * FROM products WHERE uid = $uid" );
	                if ( DBA::isResult( $r ) ) {
	                        $json = json_encode( $r );
	                }
			foreach( $r as $datum ) {
				$userproducts[ $datum[ "id" ] ] = getUsernameById( $datum[ "uid" ] );
			}
			$userproducts = json_encode( $userproducts );

		        $o .=  <<< EOT

		        <h3>My store</h3>
		        <p>Select a product for more info</p>
			<div align="right"><a href="/marketplace/new-product/"><button class="btn btn-default">New product</button></a></div>
			<script></script>

		        <div id="products"></div>

			<br><br>

		        <script>
				var products = $json;
				products.sort(function(a, b){return b[ "id" ] - a[ "id" ]});
				var userproducts = $userproducts;
		                function addProduct( name, description, details, profile, cats, price ) {
					cats = cats.split( ", " );
					var categories = "";
					var i; for ( i=0; i<cats.length; i++ ) {
						categories += '<div class="category" style="background-color: #ddd; padding: 3px; padding-left: 6px; padding-right: 6px; border-radius: 10px; display: inline-block; margin-left: 5px;">'
							+ '<span class="xcat" style="cursor: pointer;">&times;</span> ' + '<span class="pluscat" style="cursor: pointer;">' + cats[ i ] + '</span>'
						+ '</div>';
					}
					price = "$" + ( price / 100 ).toFixed( 2 ) + " (USD)";
		                        document.getElementById( "products" ).innerHTML +=
					'<div class="prodbox" style="border-radius: 10px; padding: 10px; background-color: white; box-shadow: 2px 2px 5px black; margin: 5px;">'
						+ '<span class="prodname" style="font-weight: bold;">' + name + '</span>'
						+ '<div class="catbox" style="float: right;">'
							+ categories
						+ '</div>'
						+ '<div class="proddesc">' + description + '</div>'
						+ '<div class="prodprice">Price: ' + price + '</div>'
						+ '<hr class="separator" style="width: 100%; visibility: hidden;" />'
						+ '<div class="prodbtnbox" align="right">'
							+ '<a class="prodbtn" href="' + details + '">Details</a> | '
							+ '<a class="prodbtn" href="' + profile + '">Contact</a>'
						+ '</div>'
					+ '</div>';
		                }
				products.forEach( function( item ) {
					addProduct( item[ "name" ], item[ "descr" ], "$base/marketplace/details/?product=" + item[ "id" ], "$base/profile/" + userproducts[ item[ "id" ] ], item[ "cat" ], item[ "price" ] );
				});
		        </script>
			<script>
				var i; for ( i=0; i<document.getElementsByClassName( "xcat" ).length; i++ ) {
					document.getElementsByClassName( "xcat" )[ i ].addEventListener( "click", function() {
						sessionStorage[ "filter" ] = this.nextElementSibling.innerText;
						var j; for ( j=0; j<document.getElementsByClassName( "catbox" ).length; j++ ) {
							if ( document.getElementsByClassName( "catbox" )[ j ].innerText.includes( sessionStorage[ "filter" ] ) ) {
								document.getElementsByClassName( "catbox" )[ j ].parentElement.style.display = "none";
							}
						}
					});
				}
                                var i; for ( i=0; i<document.getElementsByClassName( "pluscat" ).length; i++ ) {
                                        document.getElementsByClassName( "pluscat" )[ i ].addEventListener( "click", function() {
                                                sessionStorage[ "filter" ] = this.innerText;
                                                var j; for ( j=0; j<document.getElementsByClassName( "catbox" ).length; j++ ) {
                                                        if ( !document.getElementsByClassName( "catbox" )[ j ].innerText.includes( sessionStorage[ "filter" ] ) ) {
                                                                document.getElementsByClassName( "catbox" )[ j ].parentElement.style.display = "none";
                                                        }
                                                }
                                        });
                                }
			</script>

EOT;
		} else {
                        $o .=  <<< EOT
                        <h3>Sorry!</h3>
                        <p>Please <a href="$base/register/">register</a> before creating a store.</p>
EOT;
		}
	}

        if ( strpos( $_SERVER['REQUEST_URI'], '/wallet/' ) > -1 ) {
                $o .=  <<< EOT
                <h3>Wallet</h3>
                <p>Coming soon</p>
EOT;
        }

        if ( strpos( $_SERVER['REQUEST_URI'], '/new-product/' ) > -1 ) {
                $uid = getCurrentUserId();
                $r = q( "SELECT id FROM products WHERE uid = $uid" );
                if ( DBA::isResult( $r ) ) {
                        $products = $r;
			$pdata = json_encode( $products );
                }
                $s = q( "SELECT id FROM wallets WHERE uid = $uid" );
//		$s = q( "SELECT * FROM wallets" );
                if ( DBA::isResult( $s ) ) {
                        $wallet = $s;
                        $wdata = json_encode( $wallet );
                }
		if ( getCurrentUserId() == 0 ) {
                        $o .=  <<< EOT
                        <h3>Sorry!</h3>
                        <p>Please <a href="$base/register/">register</a> before creating a store.</p>
EOT;
                }
                if ( getCurrentUserId() != 0 && $_POST[ "product-name" ] && $_POST[ "description" ] && $_POST[ "price" ] ) {
                        $productname = $_POST[ "product-name" ];
                        $description = $_POST[ "description" ];
			$categories = $_POST[ "categories" ];
                        $price = $_POST[ "price" ];
			if ( $_POST[ "latitude" ] && $_POST[ "longitude" ] ) {
				$latlong = $_POST[ "latitude" ] . "," . $_POST[ "longitude" ];
			} else {
				$latlong = "";
			}
			if ( $_POST[ "sid" ] ) {
	                        $sid = $_POST[ "sid" ];
			} else {
				$sid = "";
			}
			if ( $_POST[ "buynow" ] == "on" ) {
                                $buynow = 1;
                        } else {
				$buynow = "";
			}
                        createProduct( $productname, $description, $categories, $price, $latlong, $sid, $buynow, $uid );
			createWallet( $uid );
                }
                if ( getCurrentUserId() != 0 ) {
                        $o .=  <<< EOT
                        <h3>Add a product</h3>
                        <div id="instructions" style="padding: 10px; border: 3px solid black;">
                                <p style="font-weight: bold;">Instructions</p>
                                <p>Enter a name, description, categories, and price for your product. You'll also need a latitude and a longitude which help us place a pin on our map. Get your latitude and longitude from <a href="https://latlong.net/" target="_blank">latlong.net</a>. On that site, enter a place name or click on the map. The latitude and longitude appear as two numbers separated by a comma. The left number is latitude, the right number is longitude. If either number has a negative sign, don't delete it -- the negative sign is important for that number so that your pin gets placed in the right spot on the map.</p>
                        </div>
			<p>$pdata</p>
			<p>$wdata</p>
			<br>
                        <form method="post">
                                <p style="font-weight: bold;">Product name</p>
                                <input type="text" id="product-name" name="product-name"><br><br>
                                <p style="font-weight: bold;">Description</p>
                                <textarea cols="40" rows="6" id="description" name="description"></textarea><br><br>
                                <p><strong>Categories</strong> (separated by a comma and a space, e.g. "Automobiles, trucks, Ford")</p>
                                <input type="text" id="categories" name="categories"><br><br>
                                <p style="font-weight: bold;">Price</p>
                                $ <input type="number" step="0.01" id="publicprice" name="publicprice"> (USD)<br><br>
                                <input type="hidden" id="price" name="price">
                                <input type="checkbox" id="buynow" name="buynow"> <label for="buynow">Buy now?</label>
				<p>If you let people buy now, they can immediately send you a bitcoin payment to buy your product. Otherwise, they can contact you to work out the details.</p>
                                <p style="font-weight: bold;">Latitude</p>
                                <input type="text" id="latitude" name="latitude"><br><br>
                                <p style="font-weight: bold;">Longitude</p>
                                <input type="text" id="longitude" name="longitude"><br><br>
                                <input type="submit" id="submit" name="submit">
                        </form>
                        <br><br>
			<script>
				$("#publicprice").on( "keyup", function(){
					document.getElementById( "price" ).value = Number( document.getElementById( "publicprice" ).value ).toFixed( 2 ) * 100;
				});
			</script>
EOT;
                }
        }

        if ( strpos( $_SERVER['REQUEST_URI'], '/map/' ) > -1 ) {
                $r = q( "SELECT * FROM products" );
                if ( DBA::isResult( $r ) ) {
                        $json = json_encode( $r );
                }
                foreach( $r as $datum ) {
                        $userproducts[ $datum[ "id" ] ] = getUsernameById( $datum[ "uid" ] );
                }
                $userproducts = json_encode( $userproducts );

                $o .=  <<< EOT

                <h3>Products</h3>
                <p>Select a product using the map for more info</p>

                <div id="mapid"></div>

                <br><br>

                <script>
                        var lat = 0;
                        var lng = 0;
                        var zm = 1.4;
                        var mymap = L.map('mapid').setView([lat, lng], zm);
                        L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=LdwrABRv6rLocfqVmk9r',{
                                tileSize: 512,
                                zoomOffset: -1,
                                minZoom: 1,
	                        attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank" rel="noopener noreferrer">© MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer">© OpenStreetMap contributors</a>',
                                crossOrigin: true
                        }).addTo(mymap);
                        var redIcon = new L.Icon({
                                iconUrl: '$base/addon/marketplace/images/marker-icon-red.png',
                                shadowUrl: '$base/addon/marketplace/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                        });
                </script>

                <script>
                        var products = $json;
                        var userproducts = $userproducts;
                        function addPin( latlng, name, description, details, profile ) {
                                var lat = latlng.split( ',' )[ 0 ];
                                var lng = latlng.split( ',' )[ 1 ];
                                var iconColor = redIcon;
	                        L.marker( [ lat, lng ], { icon: redIcon } ).addTo( mymap ).bindPopup( '<span style="font-weight: bold;">' + name + '</span><br />' + description + '<hr style="width: 100%; visibility: hidden;" /><a href="' + details + '">Details</a> | <a href="' + profile + '">Contact</a>' );
                        }
                        products.forEach( function( item ) {
				addPin( item[ "latlong" ], item[ "name" ], item[ "descr" ], "$base/marketplace/details/?product=" + item[ "id" ], "$base/profile/" + userproducts[ item[ "id" ] ] );
                        });
                </script>
EOT;
	}

        //Don't delete this next line, it shows me how to do a negative constrait -- useful if I want something to show up on some but not all pages
        //if ( !( strpos( $_SERVER['REQUEST_URI'], '/details/' ) > -1 ) ) {
	if ( $o == '' ) {
                $r = q( "SELECT * FROM products" );
                if ( DBA::isResult( $r ) ) {
                        $json = json_encode( $r );
                }
		foreach( $r as $datum ) {
			$userproducts[ $datum[ "id" ] ] = getUsernameById( $datum[ "uid" ] );
		}
		$userproducts = json_encode( $userproducts );

	        $o .=  <<< EOT

	        <h3>Products</h3>
	        <p>Select a product to get more info about it</p>

	        <div id="products"></div>

		<br><br>
		<script>
			var products = $json;
			products.sort(function(a, b){return b[ "id" ] - a[ "id" ]});
			var userproducts = $userproducts;
	                function addProduct( name, description, details, profile, cats, price ) {
				cats = cats.split( ", " );
				var categories = "";
				var i; for ( i=0; i<cats.length; i++ ) {
					categories += '<div class="category" style="background-color: #ddd; padding: 3px; padding-left: 6px; padding-right: 6px; border-radius: 10px; display: inline-block; margin-left: 5px;">'
						+ '<span class="xcat" style="cursor: pointer;">&times;</span> ' + '<span class="pluscat" style="cursor: pointer;">' + cats[ i ] + '</span>'
					+ '</div>';
				}
                                price = "$" + ( price / 100 ).toFixed( 2 ) + " (USD)";
	                        document.getElementById( "products" ).innerHTML +=
				'<div class="prodbox" style="border-radius: 10px; padding: 10px; background-color: white; box-shadow: 2px 2px 5px black; margin: 5px;">'
					+ '<span class="prodname" style="font-weight: bold;">' + name + '</span>'
					+ '<div class="catbox" style="float: right;">'
						+ categories
					+ '</div>'
					+ '<div class="proddesc">' + description + '</div>'
                                        + '<div class="prodprice">Price: ' + price + '</div>'
					+ '<hr class="separator" style="width: 100%; visibility: hidden;" />'
					+ '<div class="prodbtnbox" align="right">'
						+ '<a class="prodbtn" href="' + details + '">Details</a> | '
						+ '<a class="prodbtn" href="' + profile + '">Contact</a>'
					+ '</div>'
				+ '</div>';
	                }
			products.forEach( function( item ) {
				addProduct( item[ "name" ], item[ "descr" ], "$base/marketplace/details/?product=" + item[ "id" ], "$base/profile/" + userproducts[ item[ "id" ] ], item[ "cat" ], item[ "price" ] );
			});
	        </script>
		<script>
			var i; for ( i=0; i<document.getElementsByClassName( "xcat" ).length; i++ ) {
				document.getElementsByClassName( "xcat" )[ i ].addEventListener( "click", function() {
					sessionStorage[ "filter" ] = this.nextElementSibling.innerText;
					var j; for ( j=0; j<document.getElementsByClassName( "catbox" ).length; j++ ) {
						if ( document.getElementsByClassName( "catbox" )[ j ].innerText.includes( sessionStorage[ "filter" ] ) ) {
							document.getElementsByClassName( "catbox" )[ j ].parentElement.style.display = "none";
						}
					}
				});
			}
                        var i; for ( i=0; i<document.getElementsByClassName( "pluscat" ).length; i++ ) {
                                document.getElementsByClassName( "pluscat" )[ i ].addEventListener( "click", function() {
                                        sessionStorage[ "filter" ] = this.innerText;
                                        var j; for ( j=0; j<document.getElementsByClassName( "catbox" ).length; j++ ) {
                                                if ( !document.getElementsByClassName( "catbox" )[ j ].innerText.includes( sessionStorage[ "filter" ] ) ) {
                                                        document.getElementsByClassName( "catbox" )[ j ].parentElement.style.display = "none";
                                                }
                                        }
                                });
                        }
		</script>

EOT;
	}

	return $o;
}

function makeMarketplaceTables() {
        if (DI::config()->get('retriever', 'dbversion') != '1.0') {
                $schema = file_get_contents(dirname(__file__).'/database.sql');
                $arr = explode(';', $schema);
                foreach ($arr as $a) {
                        $r = q($a);
                }
                DI::config()->set('marketplace', 'dbversion', '1.0');
        }
}

function getCurrentUserId() {
	$profileurl = Profile::getMyURL();
	$username = substr( $profileurl, strpos( $profileurl, 'profile' ) + 8 );
	$user = User::getByNickname( $username, array( "uid" ) );
	return $user[ "uid" ];
}

function getUsernameById( $id ) {
	$profileurl = User::getById( $id );
	$username = $profileurl[ "nickname" ];
	return $username;
}

function createProduct( $productname, $description, $categories, $price, $latlong = "", $sid = "", $buynow = "", $uid ) {
        $fields[ 'uid' ] = $uid;
        $fields[ 'name' ] = filter_var( $productname, FILTER_SANITIZE_STRING );
        $fields[ 'descr' ] = filter_var( $description, FILTER_SANITIZE_STRING );
        $fields[ 'cat' ] = filter_var( $categories, FILTER_SANITIZE_STRING );
        $fields[ 'price' ] = filter_var( $price, FILTER_SANITIZE_STRING );
        $fields[ 'latlong' ] = filter_var( $latlong, FILTER_SANITIZE_STRING );
        $fields[ 'status' ] = 1;
        if ( !empty( $sid ) ) {
        	$fields[ 'sid' ] = $sid;
        }
        if ( !empty( $buynow ) ) {
        	$fields[ 'buynow' ] = 1;
        } else {
        	$fields[ 'buynow' ] = 0;
        }
        DBA::insert( 'products', $fields );
}

function createWallet( $uid ) {
        $r = q( "SELECT * FROM wallets WHERE uid = $uid" );
        if ( DBA::isResult( $r ) ) {
                $wallet = $r;
        }
	if ( empty( $wallet ) ) {
		$fields[ 'uid' ] = $uid;
        	$fields[ 'lnbits-domain' ] = "https://lnbits.com";
        	$fields[ 'lnbits-api-key' ] = "0181272b3b5c47db828118accc39405f";
        	$fields[ 'lnbits-user' ] = "6447d24778514d21a746aa9c38cd4951";
        	$fields[ 'lnbits-wallet' ] = "9c05fe586bb44c638066c6ecc9defd82";
        	DBA::insert( 'wallets', $fields );
	}
}

